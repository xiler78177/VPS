# WireGuard 境外模式：VLESS-Reality 封装部署教程

本教程旨在指导您如何在境外的 VPS 上部署 WireGuard 时，利用 3X-UI 的 VLESS-Reality 入站，将 WireGuard 的 UDP 流量伪装为正常的 HTTPS/TLS 流量。此方案能有效对抗 GFW 对跨国 UDP 流量的封锁、审查以及运营商的 QOS（服务质量）限速，提供稳定且安全的隧道连接。

**核心架构**：
`WireGuard 客户端 (UDP)` → `本地 Xray (VLESS 协议)` → `公网加密 TLS 流量传输` → `境外 3X-UI Xray (Reality 解除伪装)` → `境外 VPS 本机 WireGuard 服务端 (UDP)`

---

## 一、 前期准备

1. **一台境外 VPS**：已安装并配置好基础系统环境（推荐 Debian / Ubuntu）。
2. **已部署 3X-UI 面板**：VPS 上需提前安装好 3X-UI 面板并确保其正常运行。3X-UI 将负责接收并处理 VLESS-Reality 流量。
3. **部署脚本准备**：请确保您使用的是包含 `11-wireguard.sh` 以及 `11b-wireguard-tunnel.sh` 模块的一键安装脚本集。

---

## 二、 服务端部署与配置阶段

### 1. 初始安装部署
在运行安装脚本并进入 WireGuard 部署流程时，系统会提示您选择网络部署模式：
- **请务必选择 `overseas` (境外模式)**。
> **原理说明**：在境外模式下，脚本会强制 WireGuard 服务端仅监听本地回环地址 `127.0.0.1`，而不是 `0.0.0.0`。这就意味着该 WG 服务端不直接对外暴露端口，而是完全依赖后续建立的 VLESS 隧道进行流量引入，极大提升了安全性。

### 2. 生成 VLESS-Reality 隧道参数
WireGuard 基础安装完毕后，进入功能菜单，选择 **隧道管理 / VLESS-Reality 隧道管理 -> 重新配置隧道参数**。

在交互式配置中，根据提示进行以下设置：
- **VLESS-Reality 监听端口**：输入一个未被占用的端口号（例如 `443` 或其他常用高位端口，只要不与 3X-UI 面板端口等冲突即可）。
- **Transmission (Network)**：推荐保留默认的 `tcp`。
- **Flow 控制选项**：针对 VLESS 和 TCP，推荐保留默认的 `xtls-rprx-vision`，以防止重放攻击，提高伪装效果。
- **Reality 伪装目标 (SNI)**：此处输入一个在国外未被屏蔽、支持 TLS 1.3 且有较好连通性的知名网站域名。推荐使用大厂域名，例如：
  - `www.microsoft.com`
  - `www.apple.com`
  - `www.samsung.com`

配置完成后，脚本将在后台利用 Xray 工具自动生成一对 Reality 的私钥（`PrivateKey`）、公钥（`PublicKey`）、`Short ID` 以及客户端 `UUID`。

### 3. 联动 3X-UI 创建入站节点
脚本生成参数之后，**会自动在屏幕上打印出一段包含完整配置的 JSON 文本**。这段 JSON 是专门为 3X-UI 自动生成的模板。

操作步骤如下：
1. **复制 JSON 文本**：将屏幕输出的这段长 JSON 文本完整复制下来（包含首尾的大括号 `{}`）。
2. **导入 3X-UI 面板**：
   - 登录您的 3X-UI 面板网页端。
   - 在左侧菜单中进入 **“入站列表” (Inbounds)**。
   - 找到并点击右上角附近的 **“导入” (Import)** 或 `[+]` 旁边的扩展菜单导入按钮。
   - 将刚才复制的 JSON 文本粘贴到弹出的文本框中，点击 **确定/保存**。
3. **验证配置**：在入站列表中，您应该能看到一条带有 `WG-Tunnel`（或类似备注）的 `vless` 协议入站规则。确认它的状态已启用。

> **运作机制**：3X-UI 会监听您在前面配置的 VLESS 端口。当带有指定 UUID 和 Reality 验证的流量到达时，3X-UI 的 Xray 会根据客户端发来的请求，将剥离了伪装的纯净 UDP 数据流发送给本机（VPS）`127.0.0.1` 上 WireGuard 监听的端口。整个过程不需要在 3X-UI 内再单独设置复杂的路由规则，即插即用。

---

## 三、 客户端连接与使用阶段

在服务端配置好之后，您需要在您的电脑或手机上配置双重客户端才能连上网络。

### 1. 提取客户端配置
回到 VPS 端的安装脚本菜单，进入**用户/设备管理环节 -> 查看客户端 xray 配置**。选择您为该设备分配的名称，脚本将为您展示两方面的配置信息路径（或您可以直接将其下载到本地）：

- **`[您的设备名]-xray.json`**：这是本机负责打通外网隧道的 Xray 客户端配置文件。
- **`[您的设备名].conf`**：这是标准的 WireGuard 配置文件。由于服务端的介入，该配置中的 `Endpoint` 字段已经被脚本自动替换为本地回环。

### 2. 客户端启动顺序（非常关键）

**第一步：启动本地 Xray 隧道**
您需要在您的本地设备上运行 `xray-core`。
打开终端（命令行），使用如下命令载入刚才获取的 json 配置文件：
```bash
xray run -c [您的设备名]-xray.json
```
*(注：如果您使用的是带图形界面的客户端如 v2rayN，您可以尝试通过自定义配置功能将该 json 导入运行，确保它在后台监听。)*
> 此时，您的电脑会在本地端口（通常是与 WG 服务端监听端口相同）上开启一个监听服务，它负责将收到的所有数据打包成 VLESS-Reality 流量发送到远端的 VPS。

**第二步：启动 WireGuard 建立内网**
在您的 WireGuard 官方客户端（如 Windows/macOS/Linux UI）中，导入之前提取的 `[您的设备名].conf` 文件。
然后直接点击 **“连接” (Connect)**。

> 此时，WireGuard 客户端认为它是在与“本地”通信，它发出的 UDP 加密包立刻被步骤一中守候的 Xray 拦截，加上 Reality 伪装后，穿越大火墙直达 VPS。

---

## 四、 进阶与替代方案：Clash / Mihomo 一键配置

由于同时开启 Xray 命令行和 WireGuard 客户端对部分用户来说操作略显繁琐，如果您日常使用 Clash Meta (Mihomo) 内核的客户端，脚本已经为您准备了更简单的选择。

1. 在服务端的脚本菜单中，当您完成 VLESS-Reality 的配置时，脚本通常会询问您：`是否立即生成 Clash/mihomo 客户端配置? [Y/n]`。或者您可以从菜单里手动选择生成。
2. 脚本会自动将 **VLESS-Reality 代理节点** 和 **WireGuard 节点** 进行组装，利用 Clash 内核支持的 **Chain-Proxy (链式代理或 `dialer-proxy`)** 特性，在单个 yaml 文件中描述这一串联过程。
3. 您只需要下载或复制这份 `yaml` 配置文件，导入您的 Clash/Mihomo 客户端并启用。客户端内部会自动让 WireGuard 流量先穿过 VLESS 节点，无需再手动运行 Xray-core，体验更加丝滑。

---

## 五、 错误排查指南

如果您发现 WireGuard 客户端虽然显示已连接（有发送流量），但是没有接收流量（无法上网）：

1. **检查 3X-UI 防火墙**：确保您在脚本中设置的那个 `VLESS-Reality` 监听端口，在 VPS 的防火墙（UFW/iptables）以及云服务商的安全组管控台中都已开放了 **TCP** 规则。
2. **检查服务监听状态**：
   - 在 VPS 上运行 `systemctl status x-ui` 确认面板和内部核心正常。
   - 检查 WireGuard 是否存活：`sudo wg`。如果是境外模式，终端中应该没有显式的 Endpoint（因为没有直连 IP）。
3. **核对 UUID 与短 ID**：确认本地 `xray.json` 中的 `UUID`、`PublicKey`、`ShortID` 与 3X-UI 面板中显示的 VLESS 配置参数必须完全一致。
4. **测试伪装域名**：请确保您使用的 SNI 域名（如 `www.microsoft.com`）在您的本地网络是可以直接 `ping` 通的，如果域名本身在您所在地已被 DNS 污染解析失败，Reality 伪装也无从建立连接，请在服务端脚本中更换伪装目标。
